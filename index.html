<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LonyiChat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f9;
      height: 100vh;
      overflow: hidden;
    }

    #auth-section {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 8px;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

   body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f9;
  height: 100vh;
  overflow: hidden;
}

#chat-section, {
  max-width: 100%; /* Fill the entire width */
  height: 100vh;   /* Fill the entire height */
  margin: 0;       /* Remove default margin */
  padding: 20px;    /* Keep the inner padding */
  border-radius: 0; /* Remove border-radius */
  background-color: white;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

    h1 {
      text-align: center;
    }

    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px;
      width: 100%;
      font-size: 16px;
      border: none;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      margin-top: 10px;
    }

    button:hover {
      background-color: #0056b3;
    }

    .chat-header {
      display: flex;
      justify-content: flex-end;
      position: absolute;
      top: 5px;
      right: 10px;
      z-index: 100;
    }

    .chat-header button {
      background-color: red !important;
      border: 1px solid #ccc;
      padding: 5px 10px;
      font-size: 16px;
      width: auto;
      cursor: pointer;
    }

#user-search-bar {
  margin: 0 auto;          /* Center horizontally */
  width: 50%;             /* Adjust width as needed */
  margin-left: 20px;   /* Add left margin for slight shift */
}

#user-search-bar input {
  width: 100%; 
}

    #user-search-results {
      padding: 0;
      list-style: none;
      max-height: 200px;
      /* Limit the height of the results list */
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #user-search-results li {
      cursor: pointer;
      padding: 5px 10px;
      border-bottom: 1px solid #eee;
    }

    #messages {
  height: calc(100vh - 190px); /* Adjust the subtraction value as needed */
  overflow-y: auto;
  margin-bottom: 10px;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 8px;
}

    .message {
      margin-bottom: 15px;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }

    .message-text {
      font-size: 14px;
    }

    .message span {
      font-size: 12px;
      color: gray;
    }

.message-input-section {
  /* ... existing styles ... */
  position: fixed;   /* Keep it fixed at the bottom */
  bottom: 0;        /* Position it at the very bottom */
  width: 100%;      /* Make it span the full width */
  display: flex;      /* Use flexbox for layout */
  align-items: center; /* Align items vertically */
  padding-left: 20px; /* Add left padding to the section */
}

.message-input-section input {
  /* ... existing styles ... */
  padding: 5px;
  font-size: 14px;
  width: 60%;
}

.message-input-section button {
  /* ... existing styles ... */
  padding: 5px;
  font-size: 14px;
  width: 40px;       /* Adjust width as needed */
  margin-top: 0;     /* Remove the negative margin */
  padding: 10px;    /* Adjust padding to match the input field */
}

    .message-input-section button:hover {
      background-color: #0056b3;
    }

    #current-chat-user {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* Style for the notification dot */
    .notification-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      margin-left: 5px;
    }
  </style>
</head>

<body>
  <div id="auth-section">
    <div id="login-form">
      <h1>Welcome to LonyiChat</h1>
      <input type="email" id="email" placeholder="Enter your email">
      <input type="password" id="password" placeholder="Enter your password">
      <button id="login-btn">Login</button>
      <button id="signup-btn">Sign Up</button>
    </div>

    <div id="signup-form" style="display: none;">
      <h1>Sign Up</h1>
      <input type="text" id="username-signup" placeholder="Choose a username">
      <input type="email" id="email-signup" placeholder="Enter your email">

      <input type="password" id="password-signup" placeholder="Enter your password">
      <button id="signup-submit-btn">Create Account</button>
      <button id="back-to-login-btn">Back to Login</button>
    </div>
  </div>

  <div id="chat-section" style="display: none">
    <div class="chat-header">
      <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div id="user-search-bar">
      <input type="text" id="user-search-input" placeholder="Search for a user">
    </div>
    <ul id="user-search-results"></ul>

    <div id="current-chat-user"></div>
    <div id="messages"></div>
    <div class="message-input-section">

      <input type="text" id="message-input" placeholder="Type a message">
      <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      doc,
      setDoc,
      getDoc,
      deleteDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyCDse1EY3HCAo5nLOFErEpOi5j3_-K1RTE",
      authDomain: "social-network-b0619.firebaseapp.com",
      projectId: "social-network-b0619",
      storageBucket: "social-network-b0619.firebasestorage.app",
      messagingSenderId: "868066934438",
      appId: "1:868066934438:web:65e53342a862a6b8d63e67",
      measurementId: "G-MBC24SRCVM"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const usersCollection = collection(db, "users");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const authSection = document.getElementById("auth-section");
    const chatSection = document.getElementById("chat-section");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const messagesDiv = document.getElementById("messages");
    const currentChatUser = document.getElementById("current-chat-user");

    const signupBtn = document.getElementById("signup-btn");
    const signupSubmitBtn = document.getElementById("signup-submit-btn");
    const backToLoginBtn = document.getElementById("back-to-login-btn");
    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");
    const userSearchInput = document.getElementById("user-search-input");
    const userSearchResults = document.getElementById("user-search-results");
    let currentConversationId = null;

    // Store unread messages for each conversation
    const unreadMessages = {};
    loginBtn.addEventListener("click", () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          toggleSection(true);
        })
        .catch((err) => alert(err.message));
    });
    signupBtn.addEventListener("click", () => {
      loginForm.style.display = "none";
      signupForm.style.display = "block";
    });
    backToLoginBtn.addEventListener("click", () => {
      signupForm.style.display = "none";
      loginForm.style.display = "block";
    });
    signupSubmitBtn.addEventListener("click", () => {
      const email = document.getElementById("email-signup").value;
      const password = document.getElementById("password-signup").value;
      const username = document.getElementById("username-signup").value.trim();

      if (!username) {
        alert("Please choose a username.");
        return;
      }

      createUserWithEmailAndPassword(auth, email, password)
        .then(async (userCredential) => {
          const user = userCredential.user;

          const userRef = doc(db, "users", user.uid);
          await setDoc(userRef, { username: username });

          signInWithEmailAndPassword(auth, email, password)
            .then(() => {
              toggleSection(true);
            })
            .catch((err) => alert(err.message));
        })

        .catch((err) => alert(err.message));
    });
    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    });
    function toggleSection(loggedIn) {
      if (loggedIn) {
        authSection.style.display = "none";
        chatSection.style.display = "block";
      } else {
        authSection.style.display = "block";
        chatSection.style.display = "none";
      }
    }

    userSearchInput.addEventListener("input", async () => {
      updateSearchResults();
    });
    async function startPrivateChat(userId, username) {
	userSearchResults.style.display = "none";
      const user1 = auth.currentUser.uid;
      const user2 = userId;
      const conversationId = user1 < user2 ? `${user1}-${user2}` : `${user2}-${user1}`;
      currentConversationId = conversationId;

      currentChatUser.textContent = `Chatting with: ${username}`;
      // Clear unread messages for this conversation
      unreadMessages[conversationId] = 0;
      // Update the search results to remove the notification dot
      updateSearchResults();
      const messagesCollection = collection(
        db,
        "conversations",
        conversationId,
        "messages"
      );
      listenForPrivateMessages(conversationId);

      sendBtn.onclick = async () => {
        const messageText = messageInput.value;
        if (messageText.trim() === "") return;
        messageInput.value = "";
        try {
          await addDoc(messagesCollection, {
            sender: auth.currentUser.uid,
            text: messageText,
            timestamp: new Date(),
          });
        } catch (err) {
          alert("Error sending message: ", err);
        }
      };
    }

    function listenForPrivateMessages(conversationId) {
      const messagesCollection = collection(
        db,
        "conversations",
        conversationId,
        "messages"
      );
      const q = query(messagesCollection, orderBy("timestamp"));
      onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === "added") {
            const messageData = change.doc.data();
            const sender = messageData.sender;

            // Check if the message is from the other user and not read yet
            if (sender !== auth.currentUser.uid) {
              // Increment unread count for this conversation
              unreadMessages[conversationId] = (unreadMessages[conversationId] || 0) + 1;
              // Update the search results to show the notification dot
              updateSearchResults();
            }

            appendMessage(
              messageData.text,
              sender === auth.currentUser.uid ? "you" : "them",
              messageData.timestamp
            );
          }
        });
      });
    }

 function appendMessage(text, sender, timestamp) {
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", sender);

    // Get the current user's username
    let currentUsername = "You";
    if (auth.currentUser && auth.currentUser.displayName) {
        currentUsername = auth.currentUser.displayName;
    }

    // Display the username based on the sender
    const username = sender === "you" ?
        currentUsername : currentChatUser.textContent.replace("Chatting with: ", "");

    // Format timestamp to a readable format
    const formattedTimestamp = new Date(timestamp.seconds * 1000).toLocaleString(); // Convert Firestore timestamp to a JavaScript Date object

    // Add the username and timestamp to the message
    messageDiv.innerHTML = `
        <p class="message-text"><span class="username">${username}:</span> ${text}</p>
        <span class="message-timestamp">${formattedTimestamp}</span>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

    function updateSearchResults() {
      const searchTerm = userSearchInput.value.trim().toLowerCase();
      userSearchResults.innerHTML = ""; // Clear previous results

      if (searchTerm) {
        const q = query(usersCollection);
        getDocs(q).then((querySnapshot) => {
          const seenUsernames = new Set(); // Keep track of seen usernames

          querySnapshot.forEach((doc) => {
            const username = doc.data().username;
            const userId = doc.id;

            if (
              username.toLowerCase().includes(searchTerm) &&

              userId !== auth.currentUser.uid &&
              !seenUsernames.has(username) && // Check for duplicates
              username !== "ExampleUser" // Exclude "ExampleUser"
            ) {
              seenUsernames.add(username); // Add to seen usernames

              const userItem = document.createElement("li");

              userItem.textContent = username;

              // Add notification dot if there are unread messages
              if (unreadMessages[userId] > 0) {
                const notificationDot = document.createElement("span");
                notificationDot.classList.add("notification-dot");

                userItem.appendChild(notificationDot);
              }

              userItem.addEventListener("click", () =>
                startPrivateChat(userId, username)
              );
              userSearchResults.appendChild(userItem);
            }
          });
        });
      }
    }
  </script>
</body>

</html>
