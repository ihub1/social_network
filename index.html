<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LonyiChat</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        height: 100vh;
        overflow: hidden;
      }

      #auth-section,
#signup-section {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
  border-radius: 8px;
  background-color: white;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#chat-section {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
  border-radius: 8px;
  background-color: white;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  height: 400px; /* Now only applies to the chat section */
}

      /* ... other styles ... */

      #messages {
        height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
      }

      /* ... other styles ... */

      h1 {
        text-align: center;
      }

      input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      button {
        padding: 10px;
        width: 100%;
        font-size: 16px;
        border: none;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        margin-top: 10px;
      }

      button:hover {
        background-color: #0056b3;
      }

      .chat-header {
        display: flex;
        justify-content: flex-end;
        position: absolute;
        top: 5px;
        right: 10px;
        z-index: 100;
      }

      .chat-header button {
        background-color: red !important;
        border: 1px solid #ccc;
        padding: 5px 10px;
        font-size: 16px;
        width: auto;
        cursor: pointer;
      }

      #user-list-items {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 0;
        list-style: none;
      }

      #user-list-items li {
        cursor: pointer;
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        white-space: nowrap;
      }

      #messages {
        height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
      }

      .message {
        margin-bottom: 15px;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }

      .message-text {
        font-size: 14px;
      }

      .message span {
        font-size: 12px;
        color: gray;
      }

      .message-input-section {
        display: flex;
        align-items: center;
        margin-top: 120px;
      }

      .message-input-section input {
        flex-grow: 1;
        padding: 10px;
        font-size: 16px;
        border-radius: 4px;
      }

      .message-input-section button {
        background-color: #007bff;
        color: white;
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        width: 50px;
        margin-top: -2px;
      }

      .message-input-section button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div id="auth-section">
      <h1>Welcome to LonyiChat</h1>
      <input type="email" id="email" placeholder="Enter your email" />
      <input type="password" id="password" placeholder="Enter your password" />
      <button id="login-btn">Login</button>
      <button id="signup-btn">Sign Up</button>
    </div>

    <div id="signup-section" style="display: none">
      <h1>Sign Up</h1>
      <input type="email" id="email-signup" placeholder="Enter your email" />
      <input
        type="password"
        id="password-signup"
        placeholder="Enter your password"
      />
      <input type="text" id="username-signup" placeholder="Choose a username" />
      <button id="signup-submit-btn">Create Account</button>
      <button id="back-to-login-btn">Back to Login</button>
    </div>

    <div id="user-list">
      <ul id="user-list-items"></ul>
    </div>

    <div id="chat-section" style="display: none">
      <div class="chat-header">
        <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
      <div id="messages"></div>
      <div class="message-input-section">
        <input type="text" id="message-input" placeholder="Type a message" />
        <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        orderBy,
        doc,
        setDoc,
        getDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCDse1EY3HCAo5nLOFErEpOi5j3_-K1RTE",
        authDomain: "social-network-b0619.firebaseapp.com",
        projectId: "social-network-b0619",
        storageBucket: "social-network-b0619.firebasestorage.app",
        messagingSenderId: "868066934438",
        appId: "1:868066934438:web:65e53342a862a6b8d63e67",
        measurementId: "G-MBC24SRCVM",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getFirestore();
      const usersCollection = collection(db, "users");

      const loginBtn = document.getElementById("login-btn");
      const signupBtn = document.getElementById("signup-btn");
      const signupSubmitBtn = document.getElementById("signup-submit-btn");
      const backToLoginBtn = document.getElementById("back-to-login-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const authSection = document.getElementById("auth-section");
      const signupSection = document.getElementById("signup-section");
      const chatSection = document.getElementById("chat-section");
      const userList = document.getElementById("user-list-items");
      const messageInput = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-btn");
      const messagesDiv = document.getElementById("messages");

      let currentConversationId = null;

      loginBtn.addEventListener("click", () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        signInWithEmailAndPassword(auth, email, password)
          .then(() => {
            fetchUsers();
            toggleSection(true);
          })
          .catch((err) => alert(err.message));
      });

      signupBtn.addEventListener("click", () => {
        authSection.style.display = "none";
        signupSection.style.display = "flex";
      });

      backToLoginBtn.addEventListener("click", () => {
        authSection.style.display = "block";
        signupSection.style.display = "none";
      });

      signupSubmitBtn.addEventListener("click", () => {
        const email = document.getElementById("email-signup").value;
        const password = document.getElementById("password-signup").value;
        const username = document.getElementById("username-signup").value.trim();

        if (!username) {
          alert("Please choose a username.");
          return;
        }

        createUserWithEmailAndPassword(auth, email, password)
          .then(async (userCredential) => {
            const user = userCredential.user;

            const userRef = doc(db, "users", user.uid);
            await setDoc(userRef, {username: username});

            signupSection.style.display = "none";
            chatSection.style.display = "block";
            fetchUsers();
          })
          .catch((err) => alert(err.message));
      });

      logoutBtn.addEventListener("click", () => {
        signOut(auth).then(() => {
          // Redirect to the login screen after logout
          window.location.href = "index.html"; // Assuming "index.html" is your login page
        });
      });

      function toggleSection(loggedIn) {
        if (loggedIn) {
          authSection.style.display = "none";
          chatSection.style.display = "block";
        } else {
          authSection.style.display = "block";
          chatSection.style.display = "none";
        }
      }

      function fetchUsers() {
        userList.innerHTML = "";
        const q = query(usersCollection);
        onSnapshot(q, (snapshot) => {
          if (snapshot.empty) {
            userList.innerHTML = "<li>No users found.</li>";
          } else {
            snapshot.forEach((doc) => {
              const username = doc.data().username;
              const userId = doc.id;
              if (userId !== auth.currentUser.uid && username !== "ExampleUser") {
                const userItem = document.createElement("li");
                userItem.textContent = username;

                userItem.addEventListener("click", () =>
                  startPrivateChat(userId, username)
                );
                userList.appendChild(userItem);
              }
            });
          }
        });
      }

      async function startPrivateChat(userId, username) {
        const user = auth.currentUser;
        const conversationId =
          user.uid < userId ? `${user.uid}-${userId}` : `${userId}-${user.uid}`;
        currentConversationId = conversationId;

        chatSection.style.display = "block";
        authSection.style.display = "none";
        listenForPrivateMessages(conversationId);
      }

      function listenForPrivateMessages(conversationId) {
        const messagesCollection = collection(
          db,
          "conversations",
          conversationId,
          "messages"
        );
        const q = query(messagesCollection, orderBy("timestamp"));
        onSnapshot(q, (snapshot) => {
          messagesDiv.innerHTML = "";
          snapshot.forEach((doc) => {
            const {text, sender, timestamp} = doc.data();
            const messageDiv = document.createElement("div");
            messageDiv.className = "message";
            messageDiv.innerHTML = `
                      <strong>${sender}:</strong>
                      <span class="message-text">${text}</span>
                      <span>${timestamp.toDate().toLocaleString()}</span>
                      <button class="delete-btn" data-message-id="${doc.id}">Delete</button>
                    `;
            messagesDiv.appendChild(messageDiv);

            // Add event listener to delete button
            const deleteBtn = messageDiv.querySelector(".delete-btn");
            deleteBtn.addEventListener("click", () =>
              deleteMessage(conversationId, doc.id)
            );
          });
          setTimeout(() => {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }, 100);
        });
      }

      async function deleteMessage(conversationId, messageId) {
        if (confirm("Are you sure you want to delete this message?")) {
          try {
            await deleteDoc(
              doc(db, "conversations", conversationId, "messages", messageId)
            );
          } catch (error) {
            console.error("Error deleting message:", error);
          }
        }
      }

      async function sendPrivateMessage() {
        if (!currentConversationId) {
          alert("No conversation selected.");
          return;
        }

        const message = messageInput.value.trim();
        if (!message) return;

        const user = auth.currentUser;
        const userRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userRef);
        const username = userDoc.exists() ? userDoc.data().username : user.email;

        try {
          await addDoc(collection(db, "conversations", currentConversationId, "messages"), {
            text: message,
            timestamp: new Date(),
            sender: username,
          });
          messageInput.value = "";
        } catch (error) {
          console.error("Error sending message:", error);
        }
      }

      sendBtn.addEventListener("click", sendPrivateMessage);
    </script>
  </body>
</html>
